version: 0.2

phases:
  install:
    commands:
      - DIR_AT_START=`pwd`
      #Install jq via curl, not apt-get.    
      - cd $DIR_AT_START
      - curl -O -L https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64
      - chmod +x jq-linux64
      - sudo mv jq-linux64 /usr/bin/jq
      #Install phantomjs
      - cd $DIR_AT_START
      - git clone http://github.com/craigwongva/gocontainer-phantom-public
      - gocontainer-phantom-public/ubuntu/install-phantom
      - BUILD_ID=dontKillMe 
      - gocontainer-phantom-public/ubuntu/invoke-phantom gocontainer.redf4rth.net
      - cat gocontainer-phantom-public/ubuntu/invoke-phantom.js

  build:
    commands:
      - echo empty build stage, oh well `pwd`
      - PUBLICIP=`curl http://checkip.amazonaws.com/32`

      - TEMP_SAYNEXT_SECGRP=`aws ec2 describe-security-groups --region us-west-2 | jq '.SecurityGroups | .[] | select((.GroupName | contains("saynext"))) | .GroupId' | sed s/\"//g`
      - aws ec2 authorize-security-group-ingress --group-id $TEMP_SAYNEXT_SECGRP --cidr $PUBLICIP/32 --port 8080 --protocol tcp --region us-west-2 || true

      - TEMP_GEOSERVER_SECGRP=`aws ec2 describe-security-groups --region us-west-2 | jq '.SecurityGroups | .[] | select((.GroupName | contains("geoserver"))) | .GroupId' | sed s/\"//g`
      - aws ec2 authorize-security-group-ingress --group-id $TEMP_GEOSERVER_SECGRP --cidr $PUBLICIP/32 --port 80 --protocol tcp --region us-west-2 || true

      - TEMP_GOCONTAINER_SECGRP=`aws ec2 describe-security-groups --region us-west-2 | jq '.SecurityGroups | .[] | select((.GroupName | contains("gocontainer"))) | .GroupId' | sed s/\"//g`
      - aws ec2 authorize-security-group-ingress --group-id $TEMP_GOCONTAINER_SECGRP --cidr $PUBLICIP/32 --port 8080 --protocol tcp --region us-west-2 || true
      
  post_build:
    commands:
      - cd $DIR_AT_START
      
      - if  [ -z $PAUSE_FOR_USERDATA_COMPLETION ]  ; then sleep 1200 ; else sleep $PAUSE_FOR_USERDATA_COMPLETION ; fi
      - cat gocontainer-phantom-public/ubuntu/invoke-phantom.js
      - /usr/bin/phantomjs gocontainer-phantom-public/ubuntu/invoke-phantom.js >> /tmp/output &
      - echo TRIAL01
      - cat /tmp/output
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - cat gocontainer-phantom-public/ubuntu/invoke-phantom.js
      - /usr/bin/phantomjs gocontainer-phantom-public/ubuntu/invoke-phantom.js >> /tmp/output &
      - echo TRIAL02
      - cat /tmp/output
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - cat gocontainer-phantom-public/ubuntu/invoke-phantom.js
      - /usr/bin/phantomjs gocontainer-phantom-public/ubuntu/invoke-phantom.js >> /tmp/output &
      - echo TRIAL03
      - cat /tmp/output
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - cat gocontainer-phantom-public/ubuntu/invoke-phantom.js
      - /usr/bin/phantomjs gocontainer-phantom-public/ubuntu/invoke-phantom.js >> /tmp/output &
      - echo TRIAL04
      - cat /tmp/output
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - /usr/bin/phantomjs gocontainer-phantom-public/ubuntu/invoke-phantom.js >> /tmp/output &
      - echo TRIAL05
      - cat /tmp/output
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL06
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL07
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL08
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL09
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL10
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL11
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL12
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL13
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL14
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL15
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL16
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL17
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL18
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL19
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL20
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL21
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL22
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL23
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL24
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL25
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL26
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      - echo TRIAL27
      - sleep 60
      - pkill -f phantomjs || true
      - curl --max-time 10 gocontainer.redf4rth.net:8080/green/timer/status || true
      
      - mvn package > keep_stdout_readable

      - mvn exec:java -Dexec.mainClass="com.mycompany.app.Beta" || true

      - echo $PUBLICIP, $DIR_AT_START, rc is $?
      
      - ps -ef || true      
      - pkill -f phantomjs || true
      - ps -ef | grep phantom || true
artifacts:
  files:
    - target/MyGroovy-1.0-SNAPSHOT.jar
